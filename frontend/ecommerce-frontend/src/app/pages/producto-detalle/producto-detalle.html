<div class="product-detail-screen">
  <!-- Header Mejorado -->
  <header class="detail-header">
    <div class="header-content">
      <button class="btn-back" (click)="volver()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Volver
      </button>
      
      <h1 class="detail-title">DETALLE DEL PRODUCTO</h1>
      
      @if (!esElDueno()) {
        <button 
          class="btn-favorito-header"
          (click)="toggleFavorito()"
          [disabled]="toggleandoFavorito()"
          [class.activo]="esFavorito()"
        >
          @if (toggleandoFavorito()) {
            <div class="mini-spinner"></div>
          } @else {
            {{ esFavorito() ? '‚ù§Ô∏è' : 'ü§ç' }}
          }
        </button>
      } @else {
        <div class="header-spacer"></div>
      }
    </div>
  </header>

  <!-- Estados de carga y error -->
  @if (cargando()) {
    <div class="loading-state">
      <div class="loading-spinner-large"></div>
      <p>Cargando producto...</p>
    </div>
  }

  @if (errorMsg()) {
    <div class="error-state">
      <div class="error-icon-large">‚ö†Ô∏è</div>
      <h3>Error al cargar el producto</h3>
      <p>{{ errorMsg() }}</p>
      <button class="btn-primary" (click)="volver()">Volver al inicio</button>
    </div>
  }

  <!-- Contenido Principal -->
  @if (!cargando() && producto()) {
    <main class="detail-content">
      <div class="product-detail-grid">
        
        <!-- Secci√≥n de Galer√≠a -->
        <section class="gallery-section">
          <div class="main-image-container" (click)="abrirGaleria(imagenActual())">
            <img 
              [src]="imagenes[imagenActual()]" 
              [alt]="producto()!.titulo"
              class="main-product-image"
            >
            <div class="image-overlay">
              <span class="zoom-indicator">üîç Toca para ampliar</span>
            </div>
            
            <!-- Badges -->
            <div class="image-badges">
              <span class="badge-state" [class.used]="producto()!.estado === 'usado'">
                {{ producto()!.estado === 'nuevo' ? '‚ú® Nuevo' : 'üîÑ Usado' }}
              </span>
              
              @if (!esElDueno() && esFavorito()) {
                <span class="badge-favorite">‚ù§Ô∏è En favoritos</span>
              }
            </div>
          </div>

          <!-- Miniaturas -->
          @if (imagenes.length > 1) {
            <div class="thumbnails-container">
              @for (img of imagenes; track $index) {
                <button 
                  class="thumbnail-btn"
                  [class.active]="imagenActual() === $index"
                  (click)="seleccionarImagen($index)"
                >
                  <img 
                    [src]="img" 
                    [alt]="'Miniatura ' + ($index + 1)"
                    class="thumbnail-image"
                  >
                </button>
              }
            </div>
          }
        </section>

        <!-- Secci√≥n de Informaci√≥n -->
        <section class="info-section">
          <!-- Encabezado del producto -->
          <div class="product-header">
            <h1 class="product-title">{{ producto()!.titulo }}</h1>
            <div class="price-section">
              <span class="product-price">{{ formatearPrecio(producto()!.precio) }}</span>
              <span class="price-label">Precio final</span>
            </div>
          </div>

          <!-- Metadatos -->
          <div class="metadata-grid">
            <span class="metadata-category">
              üì¶ {{ producto()!.categoria }}
            </span>
            <span class="metadata-stock" [class.out-of-stock]="producto()!.stock === 0">
              {{ producto()!.stock > 0 ? '‚úÖ En stock (' + producto()!.stock + ')' : '‚ùå Agotado' }}
            </span>
          </div>

          <!-- Informaci√≥n del Vendedor -->
          @if (!esElDueno() && infoVendedor()) {
            <div class="seller-info-card">
              <h3 class="section-subtitle">Informaci√≥n del Vendedor</h3>
              <div class="seller-content">
                <div class="seller-profile">
                  <img 
                    [src]="infoVendedor()!.avatar" 
                    [alt]="infoVendedor()!.nombre"
                    class="seller-avatar"
                    onerror="this.src='https://via.placeholder.com/80x80?text=üë§'"
                  >
                  <div class="seller-details">
                    <h4 class="seller-name">{{ infoVendedor()!.nombre }}</h4>
                  </div>
                </div>
                
                <div class="seller-actions">
                  @if (infoVendedor()!.tieneWhatsApp) {
                    <button class="btn-whatsapp-full" (click)="contactarVendedor()">
                      <span>üí¨ Contactar por WhatsApp</span>
                      <small>Respuesta r√°pida</small>
                    </button>
                  } @else {
                    <button class="btn-no-whatsapp" disabled>
                      ‚ùå WhatsApp no disponible
                    </button>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Descripci√≥n -->
          <div class="description-section">
            <h3 class="section-subtitle">Descripci√≥n</h3>
            <div class="description-content">
              <p>{{ producto()!.descripcion }}</p>
            </div>
          </div>

          <!-- Detalles T√©cnicos -->
          <div class="details-section">
            <h3 class="section-subtitle">Detalles del Producto</h3>
            <div class="details-grid">
              <div class="detail-item">
                <span class="detail-label">Publicado:</span>
                <span class="detail-value">{{ formatearFecha(producto()!.creadoEn) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Actualizado:</span>
                <span class="detail-value">{{ formatearFecha(producto()!.actualizadoEn) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ID:</span>
                <span class="detail-value">#{{ producto()!.id }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Categor√≠a:</span>
                <span class="detail-value">{{ producto()!.categoria }}</span>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="actions-section">
            @if (esElDueno()) {
              <div class="owner-actions">
                <button class="btn-edit" (click)="editarProducto()">
                  <span>‚úèÔ∏è Editar Producto</span>
                  <small>Modificar informaci√≥n</small>
                </button>
                <button 
                  class="btn-delete" 
                  (click)="eliminarProducto()" 
                  [disabled]="eliminando()"
                >
                  @if (eliminando()) {
                    <div class="mini-spinner"></div>
                  }
                  <span>{{ eliminando() ? 'Eliminando...' : 'üóëÔ∏è Eliminar Producto' }}</span>
                </button>
              </div>
            } @else {
              <div class="buyer-actions">
                <!-- Favoritos -->
                <button 
                  class="btn-favorite-large" 
                  (click)="toggleFavorito()" 
                  [disabled]="toggleandoFavorito()"
                  [class.active]="esFavorito()"
                >
                  @if (toggleandoFavorito()) {
                    <div class="mini-spinner"></div>
                  }
                  <span>
                    {{ esFavorito() ? '‚ù§Ô∏è En Favoritos' : 'ü§ç Agregar a Favoritos' }}
                  </span>
                </button>

                <!-- Carrito -->
                <div class="cart-section">
                  <div class="quantity-selector">
                    <label>Cantidad:</label>
                    <div class="quantity-controls">
                      <button 
                        class="btn-quantity" 
                        (click)="disminuirCantidad()" 
                        [disabled]="cantidadCarrito() <= 1"
                      >‚àí</button>
                      <span class="quantity-display">{{ cantidadCarrito() }}</span>
                      <button 
                        class="btn-quantity" 
                        (click)="aumentarCantidad()"
                        [disabled]="!producto() || cantidadCarrito() >= producto()!.stock"
                      >+</button>
                    </div>
                  </div>

                  @if (!estaEnCarrito()) {
                    <button 
                      class="btn-add-to-cart"
                      (click)="agregarAlCarrito()"
                      [disabled]="agregandoAlCarrito() || !producto() || producto()!.stock === 0"
                    >
                      @if (agregandoAlCarrito()) {
                        <div class="mini-spinner"></div>
                      }
                      <span>
                        {{ producto()!.stock === 0 ? '‚ùå Producto Agotado' : 'üõí Agregar al Carrito' }}
                      </span>
                    </button>
                  } @else {
                    <div class="cart-actions">
                      <button class="btn-view-cart" (click)="irAlCarrito()">
                        <span>üõí Ver en Carrito</span>
                        <small>Producto agregado</small>
                      </button>
                      <button 
                        class="btn-remove-cart" 
                        (click)="eliminarDelCarrito()" 
                        [disabled]="agregandoAlCarrito()"
                      >
                        @if (agregandoAlCarrito()) {
                          <div class="mini-spinner"></div>
                        } @else {
                          üóëÔ∏è
                        }
                      </button>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </section>
      </div>
    </main>
  }

  <!-- Modal de Galer√≠a Fullscreen -->
  @if (mostrarGaleria()) {
    <div class="gallery-modal-overlay" (click)="cerrarGaleria()">
      <div class="gallery-modal">
        <button class="btn-close-modal" (click)="cerrarGaleria()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <button class="btn-nav-modal btn-prev-modal" (click)="imagenAnterior($event)">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div class="modal-image-container" (click)="$event.stopPropagation()">
          <img 
            [src]="imagenes[imagenActual()]" 
            [alt]="producto()!.titulo"
            class="modal-image"
          >
        </div>
        
        <button class="btn-nav-modal btn-next-modal" (click)="imagenSiguiente($event)">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div class="image-counter">
          {{ imagenActual() + 1 }} / {{ imagenes.length }}
        </div>
      </div>
    </div>
  }
</div>